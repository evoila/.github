---

name: AWS CDK app change testing


on:
  workflow_call:


jobs:

  # What gets deployed are the CloudFormation templates generated by the CDK.
  # Being able to look into what the CDK generated can be useful when debugging.
  cdk-synthesize:
    name: Synthesize CloudFormation templates
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      -
        name: Check out branch proposed for merging
        uses: actions/checkout@v3
        with:
          # This job does not require git history
          fetch-depth: 1
      -
        name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          cache: npm
          # Besides .nvmrc, actions/setup-node@v3 can read the Node.js version to install from other sources:
          #  - the key `engines.node` in package.json;
          #  - the key `volta.node` in package.json;
          #  - the file .node-version; and
          #  - the file .tool-versions.
          # The key `engines` in package.json[1] is meant for distributable packages;
          # this was the conceptual reason of the Volta team for resorting to their own key[2].
          # .node-version is supported by multiple tools, but not by NVM[3], which seems the most popular, and it doesn't support semver specifications.
          # .tool-versions is supported by asdf, which seems interesting but David was too lazy to dive into.
          # 1: https://docs.npmjs.com/cli/v9/configuring-npm/package-json#engines
          # 2: https://github.com/volta-cli/volta/issues/742#issuecomment-631588143
          # 3: https://github.com/nvm-sh/nvm/issues/794
          node-version-file: .nvmrc
      -
        name: Install development dependencies
        run: >-
          npm
          --verbose
          ci
      -
        name: Set up Python
        uses: actions/setup-python@v4
        with:
          cache: pipenv
          # FIXME: Get Python version from pyproject.toml when actions/setup-python supports it[1]
          # 1: https://github.com/actions/setup-python/issues/542
          python-version-file: .python-version
      -
        name: Install Pipenv
        run: >-
          pip
          --verbose
          install
          --progress-bar=off
          --
          pipenv
      -
        name: Install dependencies
        run: >-
          pipenv
          --verbose
          install
      -
        name: Synthesize CloudFormation templates
        # The `cdk` command must run under both `pipenv run` and `npx` because:
        #  - the dependencies of the CDK code are installed in a virtualenv managed by Pipenv; and
        #  - the command `cdk` itself is installed locally by npm.
        run: >-
          pipenv
          --verbose
          run
          --
          npx
          --verbose
          --
          cdk
          --ci
          --verbose
          synthesize

  # CDK apps written in Python are Python apps and can be tested like any other Python app
  test-Python-app:
    uses: ./.github/workflows/test-Python-app.yaml
